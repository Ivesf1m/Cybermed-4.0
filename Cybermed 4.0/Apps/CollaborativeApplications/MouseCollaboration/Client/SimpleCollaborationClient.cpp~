/*
 * SimpleCollaborationClient.cpp
 *
 *  Created on: Feb 26, 2010
 *      Author: bruno
 */

#include <cybermed/cybCore.h>
#include <cybermed/cybViewMono.h>
#include <cybermed/cybViewAnaglyph.h>
#include <cybermed/cybViewColorAnaglyph.h>
#include <cybermed/cybInteratorFactory.h>
#include <cybermed/cybDefaultCollaboration.h>
#include <cybermed/cybUDPServer.h>
#include <cybermed/cybCollaborationIntegrant.h>

#include <cybermed/collaborationModelFactory.h>

#include "../../InteratorModelFactory.h"

/*class MyFactory : public CollaborationModelFactory {
	public:
		CollaborationModel *getModel(int id) {			
			switch (id) {				
				case 0:
					return new CollaborationModel("monkey.wrl");
					break;
				case 1:
					return new CollaborationModel("esfera.wrl");
					break;
			}		
		}
};*/


class TrafficMonitor : public CybThread {

private: CybCollaboration *collab;
	 int collectTime; 	
	 int time;

public:	TrafficMonitor(CybCollaboration *collab, int collectTime) {		
		this->collab = collab;
		this->collectTime = collectTime;
		time = 0;
	}

	void run() {
		this->setTime(1000);			
		cout << time << endl;

		if (time > collectTime) {
			collab->getCollaborationPerformance()->reportPerformance();
			delete collab;	
		}		
		time++;
	}	
};

int main(int argc, char *argv[]) {

	if(argc != 2){
		cout << "Error: Invalid number of arguments!" << endl;
		cout << "Please, place collaboration creator ip address." << endl;
		cout << "Stopping app..." << endl;
		return -1;
	}

	CybCollaboration* cybCollaboration = new CybDefaultCollaboration(5000, UNICAST_UDP);	
	//CybCollaboration* cybCollaboration = new CybDefaultCollaboration(5001, MULTICAST, "224.0.0.1");

	//TrafficMonitor *traffic = new TrafficMonitor(cybCollaboration, 10);
	//traffic->init();

	char *fileName1 = "Bacia-Osso.wrl";
	int numLayer = 1; //Number of layers used in this application
	int numInterator = 1;

	CybDataObtainer<cybTraits> data(numLayer, numInterator);		// Transfer the OF data to CybParameters structure

	CybViewMono view;


	//Access the parameters information of scene and graphical objects
	CybParameters *cybCore = CybParameters::getInstance();

	cybCollaboration->setDataObtainer(&data);
	cybCollaboration->setModelFactory(new InteratorModelFactory());
	cybCollaboration->joinCollab(string("testes"), InteratorModelFactory::MONKEY, argv[1], 5001);

	CybInterator* interator = cybCollaboration->getInterator();

	data.loadInteratorModel(0, 0, "monkey.wrl");
	data.startInterator(0, 0);

	interator->setColor(1, 0, 0, 1);

	/*Load the model from VRML file (layerID, fileName)*/
	data.loadModel(0, fileName1);

	/*Initialize the meshes parameters*/
	data.startParameters(numLayer);

	//Set the object color (layerID, r, g, b,a)
	cybCore->setColor(0,1,1,0.7,0.9);

	//Set the window name
	view.setWindowName("Simple Visualization");

	cout << "viewInit() " << endl;

	/*Initialize visualization*/
	view.init();



}
